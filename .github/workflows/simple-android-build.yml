name: ğŸ“± Build Live App APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: live-anchor-expo/package-lock.json
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
        
    - name: ğŸ’¾ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-live-app-${{ hashFiles('**/package-lock.json', '**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-live-app-
          
    - name: ğŸ“¥ Install Project Dependencies
      run: |
        cd live-anchor-expo
        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
        npm install --legacy-peer-deps
        
    - name: ğŸ”§ Setup Expo CLI
      run: |
        cd live-anchor-expo
        echo "ğŸ”§ é…ç½®Expo CLI..."
        npm install -g @expo/cli
        
    - name: ğŸ—ï¸ Generate Android Project
      run: |
        cd live-anchor-expo
        echo "ğŸ—ï¸ ç”ŸæˆAndroidé¡¹ç›®..."
        npx expo prebuild --platform android --clean --non-interactive
        
    - name: ğŸ”¨ Build APK
      run: |
        cd live-anchor-expo/android
        echo "ğŸ”¨ å¼€å§‹æ„å»ºAPK..."
        echo "ğŸ“± é¡¹ç›®è·¯å¾„: $(pwd)"
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon --console=plain
        
    - name: ğŸ“Š Get APK Information
      run: |
        cd live-anchor-expo/android/app/build/outputs/apk/debug
        APK_SIZE=$(du -h app-debug.apk | cut -f1)
        APK_SHA=$(sha256sum app-debug.apk | cut -d' ' -f1)
        echo "ğŸ“Š APKä¿¡æ¯:"
        echo "  ğŸ“¦ å¤§å°: $APK_SIZE"
        echo "  ğŸ” SHA256: $APK_SHA"
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
        echo "APK_SHA=$APK_SHA" >> $GITHUB_ENV
        echo "APK_PATH=live-anchor-expo/android/app/build/outputs/apk/debug/app-debug.apk" >> $GITHUB_ENV
        
    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: live-anchor-app-v${{ github.run_number }}
        path: ${{ env.APK_PATH }}
        retention-days: 30
        
    - name: ğŸ‰ Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: app-v${{ github.run_number }}
        name: ğŸ¤– Live Anchor App v${{ github.run_number }}
        body: |
          ## ğŸ“± ç›´æ’­åº”ç”¨APKæ„å»ºå®Œæˆï¼
          
          ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
          - **ğŸ“ æ–‡ä»¶å¤§å°**: ${{ env.APK_SIZE }}
          - **ğŸ” SHA256**: `${{ env.APK_SHA }}`
          - **ğŸ“… æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **ğŸ”„ æäº¤**: ${{ github.sha }}
          - **â­ ç‰ˆæœ¬**: v${{ github.run_number }}
          
          ### ğŸ“¥ ä¸‹è½½æ–¹å¼
          1ï¸âƒ£ **æ¨è**: ç‚¹å‡»ä¸‹æ–¹ `Assets` ä¸­çš„ `app-debug.apk`
          2ï¸âƒ£ **å¤‡é€‰**: åœ¨ Actions é¡µé¢ä¸‹è½½ Artifacts
          
          ### ğŸ“² å®‰è£…è¯´æ˜
          1. åœ¨Androidè®¾ç½®ä¸­å¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          2. ä¸‹è½½APKæ–‡ä»¶åˆ°è®¾å¤‡
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          4. å¦‚é‡é—®é¢˜ï¼Œå¯å°è¯•å¸è½½æ—§ç‰ˆæœ¬åé‡è£…
          
          ### ğŸ¯ åº”ç”¨åŠŸèƒ½
          - ğŸ¥ **å®æ—¶ç›´æ’­**: æ¨æµå’Œè§‚çœ‹
          - ğŸ’¬ **äº’åŠ¨èŠå¤©**: å®æ—¶å¼¹å¹•å’Œæ¶ˆæ¯
          - ğŸ **ç¤¼ç‰©ç³»ç»Ÿ**: è™šæ‹Ÿç¤¼ç‰©æ‰“èµ
          - ğŸ‘¥ **è§‚ä¼—ç®¡ç†**: ç”¨æˆ·æƒé™æ§åˆ¶
          - ğŸ¨ **ç°ä»£ç•Œé¢**: ç¾è§‚çš„UIè®¾è®¡
          
          ---
          ğŸš€ **ç”± GitHub Actions è‡ªåŠ¨æ„å»º âœ¨**
          ğŸ’¬ **å¦‚æœ‰é—®é¢˜è¯·åœ¨Issuesä¸­åé¦ˆ**
        files: ${{ env.APK_PATH }}
        draft: false
        prerelease: false
        
    - name: ğŸŠ Build Success Notification
      run: |
        echo "ğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰"
        echo "ğŸ± Live Anchor App APK æ„å»ºæˆåŠŸï¼"
        echo "ğŸ“¦ æ–‡ä»¶å¤§å°: ${{ env.APK_SIZE }}"
        echo "ğŸ” SHA256: ${{ env.APK_SHA }}"
        echo "ğŸ“¥ ä¸‹è½½é“¾æ¥å·²åˆ›å»ºåœ¨ Release ä¸­ï¼"
        echo "ğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰"